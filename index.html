<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Image Processor</title>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --panel: #ffffff; --text: #334155;
            --primary: #6366f1; --accent: #8b5cf6; --danger: #ef4444;
            --border: #e2e8f0; --success: #22c55e;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0;
            --primary: #818cf8; --border: #334155;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        header {
            background: var(--panel); border-bottom: 1px solid var(--border);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 50px; flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.2rem; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; color: transparent; font-weight: 900; }

        /* Layout */
        .workspace { display: flex; height: calc(100vh - 71px); }
        
        /* Sidebar */
        .sidebar {
            width: 380px; background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        
        /* Sidebar Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); }
        .tab-btn {
            flex: 1; padding: 12px; background: none; border: none;
            color: var(--text); cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; font-size: 0.8rem;
        }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); background: rgba(99, 102, 241, 0.05); }

        .tab-content { padding: 20px; overflow-y: auto; flex: 1; display: none; }
        .tab-content.active { display: block; }

        /* Controls */
        .control-group { margin-bottom: 20px; border-bottom: 1px dashed var(--border); padding-bottom: 15px; }
        .control-group:last-child { border: none; }
        .group-head { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); font-weight: 800; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .col { flex: 1; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; }
        
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); box-sizing: border-box; font-size: 0.9rem;
        }
        input[type="range"] { width: 100%; }
        input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--primary); }
        input[type="color"] { width: 100%; height: 30px; border: none; padding: 0; background: none; cursor: pointer; }

        /* Main Area */
        .main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .upload-box {
            border: 2px dashed var(--border); border-radius: 12px; padding: 20px;
            text-align: center; background: var(--panel); cursor: pointer; margin-bottom: 20px;
            transition: 0.2s;
        }
        .upload-box:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }

        .toolbar { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;}

        /* Grid */
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;
        }
        
        .card {
            background: var(--panel); border: 1px solid var(--border); border-radius: 8px;
            overflow: hidden; position: relative; transition: transform 0.2s; cursor: grab;
        }
        .card:active { cursor: grabbing; }
        .card.dragging { opacity: 0.5; border: 2px dashed var(--primary); }
        
        .card-img-wrap { height: 100px; position: relative; background: #eee; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-tools {
            position: absolute; top: 5px; right: 5px; display: flex; gap: 4px;
        }
        .mini-btn {
            background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 4px;
            width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .mini-btn:hover { background: var(--danger); }
        .dl-btn:hover { background: var(--success); }

        .card-info { padding: 6px; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Actions */
        .actions-panel {
            padding: 15px; background: var(--panel); border-top: 1px solid var(--border);
            display: flex; gap: 10px; flex-direction: column;
        }
        .btn {
            padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; font-size: 1rem; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text); }
        
        /* Profiles */
        .profile-bar { display: flex; gap: 5px; margin-bottom: 15px; background: var(--bg); padding: 5px; border-radius: 6px; }
        .profile-select { flex: 1; border: none; background: transparent; font-weight: bold; }

        /* Overlay */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000;
            display: none; justify-content: center; align-items: center; flex-direction: column; color: white;
        }
        .progress-box { width: 300px; text-align: center; }
        progress { width: 100%; height: 10px; margin-top: 10px; border-radius: 5px; }

    </style>
</head>
<body data-theme="light">

<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <h1>MegaTool</h1>
        <span style="font-size:0.7rem; background:var(--success); color:white; padding:2px 6px; border-radius:4px;">ULTIMATE</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn-sec" onclick="toggleTheme()" style="padding:5px 10px;">üåó Theme</button>
    </div>
</header>

<div class="workspace">
    <!-- LEFT SETTINGS -->
    <div class="sidebar">
        <!-- Profile System -->
        <div style="padding: 15px 15px 0 15px;">
            <div class="profile-bar">
                <select id="profileSelect" class="profile-select" onchange="loadProfile()">
                    <option value="default">Default Settings</option>
                    <option value="social">Social Media (Square)</option>
                    <option value="web">Web Optimized (WebP)</option>
                    <option value="thumb">Thumbnail (Small)</option>
                </select>
                <button onclick="saveProfile()" title="Save Current">üíæ</button>
                <button onclick="deleteProfile()" title="Delete" style="color:var(--danger)">üóëÔ∏è</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-adjust')">üé® Adjust</button>
            <button class="tab-btn" onclick="switchTab('tab-geom')">üìê Resize</button>
            <button class="tab-btn" onclick="switchTab('tab-wm')">¬© Watermark</button>
            <button class="tab-btn" onclick="switchTab('tab-file')">üìÇ Output</button>
        </div>

        <!-- 1. ADJUST TAB -->
        <div id="tab-adjust" class="tab-content active">
            <div class="control-group">
                <div class="group-head">Color Correction</div>
                <label>Brightness</label><input type="range" id="c_bright" min="0" max="200" value="100">
                <label>Contrast</label><input type="range" id="c_cont" min="0" max="200" value="100">
                <label>Saturation</label><input type="range" id="c_sat" min="0" max="200" value="100">
                <label>Hue Rotate</label><input type="range" id="c_hue" min="0" max="360" value="0">
            </div>
            <div class="control-group">
                <div class="group-head">Effects</div>
                <div class="row">
                    <div class="col"><label><input type="checkbox" id="c_gray"> Grayscale</label></div>
                    <div class="col"><label><input type="checkbox" id="c_sepia"> Sepia</label></div>
                    <div class="col"><label><input type="checkbox" id="c_inv"> Invert</label></div>
                </div>
                <div class="row" style="margin-top:10px">
                    <div class="col">
                        <label>Vignette (Intensity)</label>
                        <input type="range" id="c_vig" min="0" max="100" value="0">
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="group-head">Tint Overlay</div>
                <div class="row">
                    <div class="col"><input type="color" id="c_tint_col" value="#ff9900"></div>
                    <div class="col"><input type="number" id="c_tint_op" step="0.1" min="0" max="1" value="0" placeholder="Opacity 0-1"></div>
                </div>
            </div>
        </div>

        <!-- 2. GEOMETRY TAB -->
        <div id="tab-geom" class="tab-content">
            <div class="control-group">
                <div class="group-head">Dimensions</div>
                <div class="row">
                    <div class="col">
                        <label>Max Width</label>
                        <input type="number" id="g_width" placeholder="Auto">
                    </div>
                    <div class="col">
                        <label>Max Height</label>
                        <input type="number" id="g_height" placeholder="Auto">
                    </div>
                </div>
                <label style="margin-top:5px; font-weight:normal; font-size:0.75rem; color:#666">
                    Leaving one empty preserves aspect ratio.
                </label>
            </div>
            <div class="control-group">
                <div class="group-head">Crop & Frame</div>
                <label>Matte / Padding Mode</label>
                <div class="row">
                    <div class="col"><input type="checkbox" id="g_fit_box"> Fit to Box (No Crop)</div>
                    <div class="col"><input type="color" id="g_pad_col" value="#ffffff"></div>
                </div>
                <label>Rounded Corners (Radius)</label>
                <input type="range" id="g_round" min="0" max="100" value="0">
            </div>
            <div class="control-group">
                <div class="group-head">Transform</div>
                <div class="row">
                    <div class="col">
                        <label>Rotate</label>
                        <select id="g_rot">
                            <option value="0">0¬∞</option>
                            <option value="90">90¬∞ CW</option>
                            <option value="180">180¬∞</option>
                            <option value="270">90¬∞ CCW</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Flip</label>
                        <select id="g_flip">
                            <option value="none">None</option>
                            <option value="h">Horiz</option>
                            <option value="v">Vert</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. WATERMARK TAB -->
        <div id="tab-wm" class="tab-content">
            <div class="control-group">
                <div class="group-head">Type</div>
                <select id="wm_type" onchange="toggleWmType()">
                    <option value="none">No Watermark</option>
                    <option value="text">Text Watermark</option>
                    <option value="image">Logo Image</option>
                </select>
            </div>

            <!-- Text Settings -->
            <div id="wm_set_text" class="control-group" style="display:none">
                <label>Text</label>
                <input type="text" id="wm_txt" placeholder="¬© Copyright">
                <div class="row" style="margin-top:5px">
                    <div class="col"><input type="color" id="wm_col" value="#ffffff"></div>
                    <div class="col"><input type="number" id="wm_op" value="0.8" step="0.1" max="1"></div>
                </div>
            </div>

            <!-- Image Settings -->
            <div id="wm_set_img" class="control-group" style="display:none">
                <label>Upload Logo (PNG)</label>
                <input type="file" id="wm_file" accept="image/*">
                <div class="row" style="margin-top:5px">
                    <div class="col"><label>Opacity</label><input type="number" id="wm_img_op" value="0.8" step="0.1" max="1"></div>
                </div>
            </div>

            <!-- Position -->
            <div id="wm_pos_group" class="control-group" style="display:none">
                <div class="row">
                    <div class="col">
                        <label>Position</label>
                        <select id="wm_pos">
                            <option value="br">Bot-Right</option>
                            <option value="bl">Bot-Left</option>
                            <option value="tr">Top-Right</option>
                            <option value="tl">Top-Left</option>
                            <option value="c">Center</option>
                            <option value="tile">Tile</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Size %</label>
                        <input type="number" id="wm_size" value="20">
                    </div>
                </div>
                <div class="row" style="margin-top:5px">
                    <div class="col"><label>Padding (px)</label><input type="number" id="wm_pad" value="20"></div>
                </div>
            </div>
        </div>

        <!-- 4. FILE & NAME TAB -->
        <div id="tab-file" class="tab-content">
            <div class="control-group">
                <div class="group-head">Format</div>
                <select id="o_format">
                    <option value="image/jpeg">JPG</option>
                    <option value="image/png">PNG</option>
                    <option value="image/webp" selected>WebP</option>
                </select>
                <div class="row" style="margin-top:5px">
                    <div class="col">
                        <label>Quality</label>
                        <input type="number" id="o_qual" value="0.9" step="0.1" min="0.1" max="1">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="group-head">Renaming</div>
                <div class="row">
                    <div class="col"><label>Prefix</label><input type="text" id="n_pre" placeholder="vacation"></div>
                    <div class="col"><label>Suffix</label><input type="text" id="n_suf" placeholder="_edit"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Start #</label><input type="number" id="n_start" value="1"></div>
                    <div class="col">
                        <label>Date Prefix</label>
                        <input type="checkbox" id="n_date">
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Case</label>
                        <select id="n_case">
                            <option value="none">No Change</option>
                            <option value="lower">lowercase</option>
                            <option value="upper">UPPERCASE</option>
                        </select>
                    </div>
                </div>
                
                <hr style="border:0; border-top:1px dashed var(--border); margin:10px 0;">
                <label>Find & Replace</label>
                <div class="row">
                    <input type="text" id="n_find" placeholder="Find...">
                    <input type="text" id="n_rep" placeholder="Replace...">
                </div>
            </div>

            <div class="control-group">
                <div class="group-head">Advanced</div>
                <label><input type="checkbox" id="o_json"> Generate JSON Log</label>
                <label><input type="checkbox" id="o_sound" checked> Play Sound on Finish</label>
                <div style="margin-top:5px; font-size:0.7rem; color:var(--success);">
                    üîí Metadata (EXIF) is stripped automatically.
                </div>
            </div>
        </div>

        <div class="actions-panel">
            <button class="btn btn-primary" onclick="processAll()">‚ö° Process Batch</button>
            <button class="btn btn-sec" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <!-- CENTER PREVIEW -->
    <div class="main">
        <div class="upload-box" id="dropZone">
            <h3 style="margin:0; color:var(--primary)">üìÇ Drag Images Here</h3>
            <p style="margin:5px; color:#888; font-size:0.9rem">or click to browse</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
        </div>

        <div class="toolbar">
            <div id="stats" style="font-size:0.85rem; font-weight:600;">
                0 items <span style="color:#ccc">|</span> 0 MB
            </div>
            <div>
                <button class="btn-sec" style="padding:4px 8px; font-size:0.8rem" onclick="reverseList()">Sort: Reverse</button>
            </div>
        </div>

        <div class="grid" id="grid"></div>
    </div>
</div>

<!-- PROCESS OVERLAY -->
<div class="overlay" id="overlay">
    <h2>Processing...</h2>
    <div class="progress-box">
        <progress id="pBar" value="0" max="100"></progress>
        <div id="pText" style="margin-top:5px;">0/0</div>
    </div>
</div>

<script>
    // --- STATE ---
    let files = [];
    let logoBlob = null;
    let draggedItem = null;

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        loadProfile(); // Load defaults
        setupListeners();
    });

    function setupListeners() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', e => addFiles(e.target.files));

        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; });
        dropZone.addEventListener('dragleave', e => { dropZone.style.borderColor = 'var(--border)'; });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border)';
            addFiles(e.dataTransfer.files);
        });

        document.getElementById('wm_file').addEventListener('change', e => {
            if(e.target.files[0]) logoBlob = e.target.files[0];
        });

        // Live Preview triggers
        document.querySelectorAll('#tab-adjust input').forEach(el => {
            el.addEventListener('input', updateCSSPreview);
        });
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    function toggleWmType() {
        const type = document.getElementById('wm_type').value;
        document.getElementById('wm_set_text').style.display = type === 'text' ? 'block' : 'none';
        document.getElementById('wm_set_img').style.display = type === 'image' ? 'block' : 'none';
        document.getElementById('wm_pos_group').style.display = type === 'none' ? 'none' : 'block';
    }

    // --- FILE HANDLING ---
    function addFiles(newFiles) {
        const valid = Array.from(newFiles).filter(f => f.type.startsWith('image/'));
        
        // Duplicate check
        valid.forEach(f => {
            if(!files.some(existing => existing.name === f.name && existing.size === f.size)) {
                files.push(f);
            }
        });
        
        renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        let totalSize = 0;

        files.forEach((f, i) => {
            totalSize += f.size;
            const div = document.createElement('div');
            div.className = 'card';
            div.draggable = true;
            div.dataset.index = i;

            // Events for Drag Sorting
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragend', handleDragEnd);

            div.innerHTML = `
                <div class="card-img-wrap">
                    <img src="${URL.createObjectURL(f)}" class="preview-target">
                    <div class="card-tools">
                        <button class="mini-btn dl-btn" title="Download Original" onclick="downloadSingle(${i})">‚¨á</button>
                        <button class="mini-btn" title="Remove" onclick="removeFile(${i})">‚úï</button>
                    </div>
                </div>
                <div class="card-info" title="${f.name}">${f.name}</div>
            `;
            grid.appendChild(div);
        });

        document.getElementById('stats').innerHTML = 
            `${files.length} items <span style="color:#ccc">|</span> ${(totalSize/1024/1024).toFixed(1)} MB`;
        
        updateCSSPreview();
    }

    function removeFile(index) {
        files.splice(index, 1);
        renderGrid();
    }

    function clearAll() {
        files = [];
        renderGrid();
    }

    function reverseList() {
        files.reverse();
        renderGrid();
    }

    function downloadSingle(index) {
        saveAs(files[index], files[index].name);
    }

    // --- DRAG SORT LOGIC ---
    function handleDragStart(e) {
        draggedItem = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    function handleDrop(e) {
        e.stopPropagation();
        if (draggedItem !== this) {
            let from = parseInt(draggedItem.dataset.index);
            let to = parseInt(this.dataset.index);
            // Swap in array
            const temp = files[from];
            files.splice(from, 1);
            files.splice(to, 0, temp);
            renderGrid();
        }
    }
    function handleDragEnd() {
        this.classList.remove('dragging');
    }

    // --- PREVIEW CSS FILTER ---
    function updateCSSPreview() {
        const b = document.getElementById('c_bright').value;
        const c = document.getElementById('c_cont').value;
        const s = document.getElementById('c_sat').value;
        const h = document.getElementById('c_hue').value;
        const g = document.getElementById('c_gray').checked ? 1 : 0;
        const se = document.getElementById('c_sepia').checked ? 1 : 0;
        const inv = document.getElementById('c_inv').checked ? 1 : 0;

        const filter = `brightness(${b}%) contrast(${c}%) saturate(${s}%) hue-rotate(${h}deg) grayscale(${g}) sepia(${se}) invert(${inv})`;
        
        document.querySelectorAll('.preview-target').forEach(img => img.style.filter = filter);
    }

    // --- PROCESSING CORE ---
    async function processAll() {
        if(files.length === 0) return alert('No images!');
        
        const overlay = document.getElementById('overlay');
        overlay.style.display = 'flex';
        const zip = new JSZip();
        
        // Log setup
        const jsonLog = {};
        const timestamp = new Date().toISOString().slice(0,10); // YYYY-MM-DD

        // Gather Settings
        const cfg = {
            // Colors
            bright: document.getElementById('c_bright').value,
            cont: document.getElementById('c_cont').value,
            sat: document.getElementById('c_sat').value,
            hue: document.getElementById('c_hue').value,
            gray: document.getElementById('c_gray').checked,
            sepia: document.getElementById('c_sepia').checked,
            inv: document.getElementById('c_inv').checked,
            vig: document.getElementById('c_vig').value,
            tintCol: document.getElementById('c_tint_col').value,
            tintOp: document.getElementById('c_tint_op').value,
            // Geom
            w: document.getElementById('g_width').value,
            h: document.getElementById('g_height').value,
            fitBox: document.getElementById('g_fit_box').checked,
            padCol: document.getElementById('g_pad_col').value,
            round: document.getElementById('g_round').value,
            rot: document.getElementById('g_rot').value,
            flip: document.getElementById('g_flip').value,
            // WM
            wmType: document.getElementById('wm_type').value,
            wmTxt: document.getElementById('wm_txt').value,
            wmCol: document.getElementById('wm_col').value,
            wmOp: document.getElementById('wm_op').value,
            wmImgOp: document.getElementById('wm_img_op').value,
            wmPos: document.getElementById('wm_pos').value,
            wmSize: document.getElementById('wm_size').value,
            wmPad: document.getElementById('wm_pad').value,
            // Output
            fmt: document.getElementById('o_format').value,
            qual: document.getElementById('o_qual').value,
            // Name
            pre: document.getElementById('n_pre').value,
            suf: document.getElementById('n_suf').value,
            start: document.getElementById('n_start').value,
            date: document.getElementById('n_date').checked,
            case: document.getElementById('n_case').value,
            find: document.getElementById('n_find').value,
            rep: document.getElementById('n_rep').value,
        };

        // Pre-load Logo if needed
        let logoImg = null;
        if(cfg.wmType === 'image' && logoBlob) {
            logoImg = await loadImage(URL.createObjectURL(logoBlob));
        }

        const extMap = {'image/jpeg':'.jpg', 'image/png':'.png', 'image/webp':'.webp'};
        const outExt = extMap[cfg.fmt];

        for(let i=0; i<files.length; i++) {
            document.getElementById('pBar').value = ((i+1)/files.length)*100;
            document.getElementById('pText').innerText = `${i+1} / ${files.length}`;

            try {
                // 1. Process
                const blob = await processOne(files[i], cfg, logoImg);
                
                // 2. Generate Name
                let name = files[i].name.substring(0, files[i].name.lastIndexOf('.')); // strip ext
                
                // Find/Replace
                if(cfg.find) name = name.replaceAll(cfg.find, cfg.rep);
                
                // Construct
                let newName = (cfg.pre ? cfg.pre + '-' : '') + name + (cfg.suf || '');
                
                // Start number override?
                if(document.getElementById('n_start').value !== "1" || cfg.pre) {
                    // Only use number if prefix exists OR user changed start number, else keep name logic
                    // Actually simplified logic: If Prefix is set, we usually ignore original name, but user might want both.
                    // Let's stick to: If Prefix set, use Prefix + Num. If no prefix, keep name + suffix.
                    if(cfg.pre) {
                         const num = (parseInt(cfg.start) + i).toString().padStart(3, '0');
                         newName = `${cfg.pre}-${num}${cfg.suf}`;
                    }
                }
                
                // Date
                if(cfg.date) newName = `${timestamp}_${newName}`;

                // Case
                if(cfg.case === 'lower') newName = newName.toLowerCase();
                if(cfg.case === 'upper') newName = newName.toUpperCase();

                const finalName = newName + outExt;
                
                zip.file(finalName, blob);
                jsonLog[files[i].name] = finalName;

            } catch(e) { console.error(e); }
        }

        if(document.getElementById('o_json').checked) {
            zip.file("log.json", JSON.stringify(jsonLog, null, 2));
        }

        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, "MegaBatch.zip");
        
        overlay.style.display = 'none';
        if(document.getElementById('o_sound').checked) playDing();
    }

    function processOne(file, cfg, logoImg) {
        return new Promise(resolve => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');
                
                let w = img.width, h = img.height;

                // 1. Resize Calculation
                let targetW = w, targetH = h;
                if(cfg.w || cfg.h) {
                    if(cfg.fitBox && cfg.w && cfg.h) {
                        // Fit inside box (Matte)
                        // Canvas is w x h, Image is scaled to fit
                        targetW = parseInt(cfg.w);
                        targetH = parseInt(cfg.h);
                    } else {
                        // Standard Aspect Resize
                        if (cfg.w && w > cfg.w) { h *= cfg.w/w; w = cfg.w; }
                        else if (cfg.h && h > cfg.h) { w *= cfg.h/h; h = cfg.h; }
                        targetW = w; targetH = h;
                    }
                }

                // Swap for Rotation
                let canvasW = targetW, canvasH = targetH;
                if(cfg.rot == 90 || cfg.rot == 270) { canvasW = targetH; canvasH = targetW; }

                cvs.width = canvasW;
                cvs.height = canvasH;

                // 2. Background (Matte)
                ctx.fillStyle = cfg.padCol;
                ctx.fillRect(0,0, canvasW, canvasH);

                // 3. Rounded Corners (Clipping)
                if(cfg.round > 0) {
                    const r = (Math.min(canvasW, canvasH) * cfg.round) / 200; // 0-100 scale
                    ctx.beginPath();
                    ctx.roundRect(0,0, canvasW, canvasH, r);
                    ctx.clip();
                }

                ctx.save();
                
                // 4. Transforms
                ctx.translate(canvasW/2, canvasH/2);
                ctx.rotate(cfg.rot * Math.PI/180);
                ctx.scale(cfg.flip === 'h' ? -1 : 1, cfg.flip === 'v' ? -1 : 1);

                // 5. Draw Image
                // If FitBox, we need to center and scale image to fit inside targetW/targetH
                if(cfg.fitBox && cfg.w && cfg.h) {
                    const scale = Math.min(parseInt(cfg.w)/img.width, parseInt(cfg.h)/img.height);
                    const drawW = img.width * scale;
                    const drawH = img.height * scale;
                    // Filter Context
                    applyFilters(ctx, cfg);
                    ctx.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
                } else {
                    applyFilters(ctx, cfg);
                    // Standard draw
                    // If rotated 90deg, targetW/H are swapped relative to canvas, but img dimensions follow logic
                    // We draw based on Unrotated w/h
                    const drawW = (cfg.rot==90||cfg.rot==270) ? targetH : targetW;
                    const drawH = (cfg.rot==90||cfg.rot==270) ? targetW : targetH;
                    ctx.drawImage(img, -drawW/2, -drawH/2, drawW, drawH);
                }

                // 6. Vignette & Tint (drawn on top of image in transformed space)
                // Actually better to draw these after restore() to cover whole canvas uniformly
                ctx.restore();

                // Tint
                if(cfg.tintOp > 0) {
                    ctx.fillStyle = cfg.tintCol;
                    ctx.globalAlpha = cfg.tintOp;
                    ctx.globalCompositeOperation = 'overlay'; // Blend mode
                    ctx.fillRect(0,0, canvasW, canvasH);
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 1;
                }

                // Vignette
                if(cfg.vig > 0) {
                    const radius = Math.max(canvasW, canvasH) * 0.8;
                    const grd = ctx.createRadialGradient(canvasW/2, canvasH/2, radius*0.4, canvasW/2, canvasH/2, radius);
                    grd.addColorStop(0, "rgba(0,0,0,0)");
                    grd.addColorStop(1, `rgba(0,0,0,${cfg.vig/100})`);
                    ctx.fillStyle = grd;
                    ctx.fillRect(0,0, canvasW, canvasH);
                }

                // 7. Watermark
                drawWatermark(ctx, canvasW, canvasH, cfg, logoImg);

                cvs.toBlob(resolve, cfg.fmt, parseFloat(cfg.qual));
            };
            img.src = URL.createObjectURL(file);
        });
    }

    function applyFilters(ctx, cfg) {
        const f = [
            `brightness(${cfg.bright}%)`,
            `contrast(${cfg.cont}%)`,
            `saturate(${cfg.sat}%)`,
            `hue-rotate(${cfg.hue}deg)`
        ];
        if(cfg.gray) f.push('grayscale(1)');
        if(cfg.sepia) f.push('sepia(1)');
        if(cfg.inv) f.push('invert(1)');
        ctx.filter = f.join(' ');
    }

    function drawWatermark(ctx, w, h, cfg, logoImg) {
        if(cfg.wmType === 'none') return;
        
        const pad = parseInt(cfg.wmPad);
        const sizeVal = parseInt(cfg.wmSize);
        let x, y, wmW, wmH;

        ctx.save();
        
        if(cfg.wmType === 'text' && cfg.wmTxt) {
            const fontSize = (Math.max(w, h) * sizeVal) / 500;
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.fillStyle = cfg.wmCol;
            ctx.globalAlpha = cfg.wmOp;
            ctx.shadowColor="black"; ctx.shadowBlur=3;
            
            const metrics = ctx.measureText(cfg.wmTxt);
            wmW = metrics.width;
            wmH = fontSize; // approx

            // Calc Pos
            if(cfg.wmPos === 'c') { x = w/2 - wmW/2; y = h/2 + wmH/3; }
            else if(cfg.wmPos === 'tl') { x = pad; y = pad + wmH; }
            else if(cfg.wmPos === 'tr') { x = w - wmW - pad; y = pad + wmH; }
            else if(cfg.wmPos === 'bl') { x = pad; y = h - pad; }
            else if(cfg.wmPos === 'br') { x = w - wmW - pad; y = h - pad; }
            else if(cfg.wmPos === 'tile') {
                ctx.rotate(-45*Math.PI/180);
                for(let i=-w; i<w*2; i+=wmW+100) {
                    for(let j=-h; j<h*2; j+=100) ctx.fillText(cfg.wmTxt, i, j);
                }
                ctx.restore(); return;
            }
            ctx.fillText(cfg.wmTxt, x, y);

        } else if(cfg.wmType === 'image' && logoImg) {
            ctx.globalAlpha = cfg.wmImgOp;
            // Scale logo relative to canvas
            const scale = (Math.max(w,h) * (sizeVal/100)) / Math.max(logoImg.width, logoImg.height);
            wmW = logoImg.width * scale;
            wmH = logoImg.height * scale;

            if(cfg.wmPos === 'c') { x = w/2 - wmW/2; y = h/2 - wmH/2; }
            else if(cfg.wmPos === 'tl') { x = pad; y = pad; }
            else if(cfg.wmPos === 'tr') { x = w - wmW - pad; y = pad; }
            else if(cfg.wmPos === 'bl') { x = pad; y = h - wmH - pad; }
            else if(cfg.wmPos === 'br') { x = w - wmW - pad; y = h - wmH - pad; }
            
            ctx.drawImage(logoImg, x, y, wmW, wmH);
        }
        ctx.restore();
    }

    function loadImage(src) {
        return new Promise(r => { const i = new Image(); i.onload=()=>r(i); i.src=src; });
    }

    // --- PROFILES & THEME ---
    function saveProfile() {
        const inputs = document.querySelectorAll('input, select');
        const data = {};
        inputs.forEach(el => {
            if(el.id && el.id !== 'fileInput' && el.id !== 'wm_file' && el.id !== 'profileSelect') {
                data[el.id] = el.type === 'checkbox' ? el.checked : el.value;
            }
        });
        localStorage.setItem('mega_profile_' + document.getElementById('profileSelect').value, JSON.stringify(data));
        alert('Settings Saved!');
    }

    function loadProfile() {
        const name = document.getElementById('profileSelect').value;
        const data = JSON.parse(localStorage.getItem('mega_profile_' + name));
        if(!data) return; // No saved data for this slot
        
        for(const [k, v] of Object.entries(data)) {
            const el = document.getElementById(k);
            if(el) {
                if(el.type === 'checkbox') el.checked = v;
                else el.value = v;
            }
        }
        toggleWmType(); // refresh UI
        updateCSSPreview();
    }

    function deleteProfile() {
        localStorage.removeItem('mega_profile_' + document.getElementById('profileSelect').value);
        alert('Profile Reset');
    }

    function toggleTheme() {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme')==='light'?'dark':'light');
    }

    function playDing() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
    }
</script>
</body>
</html>
